<!--
title: Vault
description: Un gestionnaire de secrets avec API !
published: true
date: 2021-05-30T17:28:54.127Z
tags: 
editor: ckeditor
dateCreated: 2021-05-24T10:34:59.737Z
-->

<figure class="image image_resized" style="width:18.97%;"><img src="https://www.drupal.org/files/project-images/Vault_VerticalLogo_FullColor_2_0.png" alt="HashiCorp Vault - AppRole Authentication | Drupal.org"></figure>
<h1>Pr√©sentation</h1>
<p>Vault est - comme son nom l'indique - un coffre-fort pour vos donn√©es. Il va vous permettre d'acc√©der en toute s√©curit√© √† vos secrets... Pour rappel, les <i>secrets, </i>sont des informations sensibles : comme par exemple un nom d'utilisateur et son mot de passe ou m√™me encore des fichiers, par exemple des cl√©s SSH.</p>
<p>Globalement un <i>secret</i> est une information dont vous souhaitez contr√¥ler l'acc√®s.</p>
<p>Vault est donc un outil qui fournit une interface unifi√©e pour toutes vos informations sensibles et donc centralise l'information :</p>
<p>Plus besoin de chercher votre mot de passe <code>root</code> de base de donn√©es pendant des heures ! ü§¨</p>
<p>Et d'en arriver √† prier pour qu'il se trouve dans le fichier <code>configuration.php</code> ... ( de toute fa√ßon vous ne mettez jamais l'acc√®s <code>root</code> pour vos applications?non?! )</p>
<p>De plus avec Vault, on va garantir un contr√¥le d'acc√®s strict aux donn√©es sensibles avec en autre une gestion des droits et acc√®s utilisateurs, mais aussi la tenue d'un d'un journal d'audit d√©taill√©.</p>
<p>Il s'agit vraiment d'un outil tr√®s complet, qui permet encore plus de choses ( extrait traduit de la documentation officielle ) :</p>
<blockquote>
  <ul>
    <li>Stockage secret s√©curis√©: Vault crypte les secrets avant de les √©crire dans le stockage persistant, donc acc√©der au stockage brut ne suffit pas pour acc√©der √† vos secrets.</li>
    <li>Secrets dynamiques: Vault peut g√©n√©rer des secrets √† la demande pour certains syst√®mes, tels que les bases de donn√©es AWS ou SQL. Apr√®s avoir cr√©√© ces secrets dynamiques, Vault les r√©voquera √©galement automatiquement une fois le bail termin√©.</li>
    <li>Chiffrement des donn√©es: Vault peut chiffrer et d√©chiffrer les donn√©es sans les stocker. Cela permet aux √©quipes de s√©curit√© de d√©finir des param√®tres de chiffrement et aux d√©veloppeurs de stocker des donn√©es chiffr√©es dans un emplacement tel que SQL sans avoir √† concevoir leurs propres m√©thodes de chiffrement.</li>
    <li>Location et renouvellement: tous les secrets de Vault sont associ√©s √† un bail. √Ä la fin du bail, Vault r√©voquera automatiquement ce secret. Les clients peuvent renouveler les baux via des API de renouvellement int√©gr√©es.</li>
    <li>R√©vocation: Vault prend en charge la r√©vocation des secrets. L'outil peut r√©voquer non seulement des secrets uniques, mais aussi un arbre entier de secrets. Par exemple tous les secrets lus par un utilisateur sp√©cifique, ou tous les secrets d'un type particulier.</li>
  </ul>
</blockquote>
<p>√Ä noter que Vault propose plusieurs solutions de stockage des secrets: sur le disque, en m√©moire ou bien dans une base <i>key value (KV)</i> comme <code>Consul</code>.</p>
<p>Comme tous les outils complets, la premi√®re prise en main et sa d√©couverte peut s'av√©rer parfois complexe.</p>
<h1>Installation</h1>
<p>Il faut commencer par cr√©er le fichier de configuration <code>vault.json</code> dans <code>/apps/vault/config/</code> :</p>
<pre><code class="language-xml">{
  "backend": {
    "file": {
      "path": "/vault/file"
    }
  },
  "listener": {
    "tcp":{
      "address": "0.0.0.0:8200",
      "tls_disable": 1
    }
  },
  "ui": true
}</code></pre>
<p>Puis cr√©er le <code>docker-compose.yml</code> et lancer Vault avec la commande <code>docker-compose up -d</code> :</p>
<pre><code class="language-plaintext">version: '2'
services:
  vault:
    image: vault
    container_name: vault
    restart: always
    volumes:
      - /apps/vault/logs:/vault/logs
      - /apps/vault/file:/vault/file
      - /apps/vault/config:/vault/config
    cap_add:
      - IPC_LOCK
    entrypoint: vault server -config=/vault/config/vault.json
    
    #Facultatif avec Traefik
    #ports:
    #  - "8200:8200"

    # Facultatif : support de Loki
    logging:
      driver: loki
      options:
        loki-url: "$URL_LOKI"
        loki-external-labels: service={{.Name}}
    
    # Facultatif : support de Traefik
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.entrypoints=http"
      - "traefik.http.routers.vault.rule=Host(`$URL`)"
      - "traefik.http.middlewares.vault-https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.vault.middlewares=$SERVICE-https-redirect"
      - "traefik.http.routers.vault-secure.entrypoints=https"
      - "traefik.http.routers.vault-secure.rule=Host(`$URL`)"
      - "traefik.http.routers.vault-secure.tls=true"
      - "traefik.http.routers.vault-secure.tls.certresolver=http"
      - "traefik.http.services.vault-secure.loadbalancer.server.port=8200"
      - "traefik.docker.network=proxy"

networks:
  proxy:
    external:
      name: proxy</code></pre>
<blockquote>
  <p><strong>Attention :</strong> Pensez √† changer dans le docker-compose ou √† d√©finir les variables suivantes : <i><strong>URL_LOK</strong></i><strong>I </strong>et <strong>$URL</strong> en fonction de votre installation.</p>
</blockquote>
<p>Votre Vault sera accessible directement depuis l'URL que vous lui aurais attribu√© avec Traefik ou depuis <code>http://&lt;server&gt;:&lt;port&gt;</code>.</p>
<h1>Utilisation</h1>
<h2>R√©cup√©rer un mot de passe avec l'API</h2>
<h3>Les commandes</h3>
<p>Il va nous falloir plusieurs donn√©es pour r√©cup√©rer un mot de passe :</p>
<ul>
  <li>VAULT_URL : L'URL de votre serveur VAULT (exemple : "<i>https://vault.papamica.com</i>")</li>
  <li>VAULT_ENGINE : Correspond √† l'engine racine de votre dossier contenant vos secrets</li>
  <li>VAULT_ROLE : Correspond au nom du dossier qui contient les secrets</li>
  <li>VAULT_SECRET_ID : Correspond √† l'ID r√©cup√©r√© au pr√©alable avec la commande <code>vault write -force auth/approle/role/&lt;VAULT_ROLE&gt;/secret-id</code></li>
  <li>VAULT_SECRET_NAME : Correspond au nom du secret</li>
</ul>
<p>R√©cup√©ration du VAULT_TOKEN pour acc√©der aux secrets :</p>
<pre><code class="language-plaintext">VAULT_TOKEN=$(curl -sSf --data "{\"role_id\":\"&lt;ROLE_ID&gt;\",\"secret_id\":\"$VAULT_SECRET_ID\"}" $VAULT_URL/v1/auth/approle/login | jq -r '.["auth"]["client_token"]')</code></pre>
<p>R√©cup√©ration des secrets dans le dossier en Json ;</p>
<pre><code class="language-plaintext">curl -sSf -X GET -H "Accept: */*" -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_URL/v1/$VAULT_ENGINE/data/approle/$VAULT_ROLE"</code></pre>
<p>R√©cup√©ration du secret recherch√© avec jq :</p>
<pre><code class="language-plaintext"> | jq -r '.["data"]["data"]["$VAULT_SECRET_NAME"]'</code></pre>
<p>&nbsp;</p>
<h3>R√©cup√©ration des secrets dans un script :</h3>
<h4>Variable d'environnement √† configurer</h4>
<p>Afin de ne pas d√©voiler les informations ou les tokens utilis√©s, on les met en variable d'environnement :</p>
<pre><code class="language-python">export VAULT_URL='' # Vault URL with "https://"
export VAULT_ENGINE='' # Wallet name (ex : VPS)
export VAULT_ROLE='' # Role name (folder)
export VAULT_SECRET_ID='' # To be retrieved in Vault CLI with 'vault write -force auth/approle/role/&lt;VAULT_ROLE&gt;/secret-id'
export VAULT_SECRET_NAME='' # Secret name</code></pre>
<p>&nbsp;</p>
<h4>Fonction Bash</h4>
<pre><code class="language-python">#!/bin/bash

function Get-Secret {
    VAULT_TOKEN=$(curl -sSf --data "{\"role_id\":\"$VAULT_ROLE\",\"secret_id\":\"$VAULT_SECRET_ID\"}" $VAULT_URL/v1/auth/approle/login | jq -r '.["auth"]["client_token"]')
    SECRET=$(curl -sSf -X GET -H "Accept: */*" -H "X-Vault-Token: $VAULT_TOKEN" "$VAULT_URL/v1/$VAULT_ENGINE/data/approle/$VAULT_ROLE" | jq -r --arg VAULT_SECRET_NAME "$VAULT_SECRET_NAME" '.["data"]["data"][$VAULT_SECRET_NAME]')
    echo "$SECRET"
}

VAULT_SECRET_NAME='kaypair'
PASSWORD=$(Get-Secret)
echo $PASSWORD</code></pre>
<p>&nbsp;</p>
<h4>Fonction Python</h4>
<pre><code class="language-python">#!/usr/bin/env python
import requests
import os
import json

# Variables declaration
VAULT_URL = os.getenv('VAULT_URL')
VAULT_ENGINE = os.getenv('VAULT_ENGINE')
VAULT_ROLE = os.getenv('VAULT_ROLE')
VAULT_SECRET_ID = os.getenv('VAULT_SECRET_ID')

def GetSecret():
    # Get token access
    data = {"role_id":VAULT_ROLE,"secret_id":VAULT_SECRET_ID}
    response = requests.post(VAULT_URL + '/v1/auth/approle/login', data=data)
    JSON = json.loads(response.text)
    TOKEN = JSON["auth"]["client_token"]
    # Get secret
    headers = {
        'Accept': '*/*',
        'X-Vault-Token': TOKEN
    }
    response = requests.get(VAULT_URL + '/v1/' + VAULT_ENGINE + '/data/approle/' + VAULT_ROLE, headers=headers)
    JSON = json.loads(response.text)
    SECRET = JSON["data"]["data"][VAULT_SECRET_NAME]
    return SECRET

VAULT_SECRET_NAME='kaypair'
SECRET = GetSecret()
print (SECRET)</code></pre>

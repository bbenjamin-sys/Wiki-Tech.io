<!--
title: Healthcheck
description: S‚Äôassurer du bon fonctionnement de ses containers !
published: true
date: 2021-05-20T14:34:11.398Z
tags: 
editor: ckeditor
dateCreated: 2021-05-05T11:48:38.363Z
-->

<figure class="image image_resized" style="width:61.98%;"><img src="https://static1.squarespace.com/static/5e8f3a0561b8203ce00e89de/t/5ef36831fdac3120d5c11a7f/1605732226441/" alt="HealthCheck"></figure>
<h1>Pr√©sentation</h1>
<p>Le m√©canisme de healthcheck n'est pas une nouveaut√© dans Docker... Pr√©sent depuis la version 1.12 ce m√©canisme reste pourtant peu utilis√©...</p>
<p>Tout d'abord l'instruction <code>HEALTHCHECK</code> , c'est quoi ?</p>
<p>Elle indique √† Docker comment tester votre container pour v√©rifier qu'il fonctionne toujours correctement ( Oui oui, j'ai r√©ussi √† vous traduire la documentation officielle ) :</p>
<blockquote>
  <p>The <code>HEALTHCHECK</code> instruction tells Docker how to test a container to check that it is still working. This can detect cases such as a web server that is stuck in an infinite loop and unable to handle new connections, even though the server process is still running.</p>
</blockquote>
<p>Nous avions d√©j√† pu voir comment relancer automatiquement un container dont le processus principal ( vous savez le programme qui prend le <code>PID 1</code> dans votre container ) ne fonctionne plus, et ceci √† l'aide de l'instruction <code>restart.</code></p>
<p>Mais voil√†, dans votre malheur le <code>PID 1</code> de votre instance est toujours actif mais pourtant il ne remplit plus son r√¥le :</p>
<blockquote>
  <p>Par exemple <code>nginx</code> est toujours <i>UP</i> mais il ne dessert plus vos pages correctement et/ou vous remonte une erreur <i><strong>404/503 </strong></i>!</p>
</blockquote>
<p><br>Dans ce moment l√†, plusieurs solutions :</p>
<ul>
  <li>La supervision finit par vous remonter l'information et vous intervenez ( de fa√ßon automatique ou non ),</li>
  <li>On int√®gre un healthcheck √† notre service pour v√©rifier sa bonne sant√© et ainsi avoir l'information en temps r√©el.</li>
</ul>
<h1><strong>Healthcheck</strong></h1>
<p>Il est possible de d√©clarer un <code>HEALTHCHECK</code> de deux fa√ßons :</p>
<ul>
  <li>Dans votre fichier <code>Dockerfile</code> avant de build votre image,</li>
  <li>Lors de la d√©claration du service dans le fichier docker-compose.</li>
</ul>
<p>Plut√¥t que de long discours, voyons par l'exemple la diff√©rence entre ces deux types de d√©clarations.</p>
<p>&nbsp;</p>
<h2>Dans un dockerfile</h2>
<p>Voici un exemple de fichier <code>Dockerfile</code> qui va construire une image custom du CMS <code>Ghost</code>:</p>
<pre><code class="language-plaintext">FROM ghost:3

RUN apt update &amp;&amp; apt install curl -y \
        &amp;&amp; rm -rf /var/lib/apt/lists/*
        
HEALTHCHECK --interval=1m --timeout=30s --retries=3 CMD curl --fail http://localhost:2368 || exit 1</code></pre>
<p>üö© Alors oui il est n√©cessaire d'installer <code>curl</code> qui n'est pas pr√©sent dans l'image. Pour les personnes qui souhaitent pousser la r√©flexion plus loin, voici un <a href="https://blog.sixeyed.com/docker-healthchecks-why-not-to-use-curl-or-iwr/">article tr√®s int√©ressant</a>. üö©</p>
<p>Voici la liste des options qu'il est possible d'ajouter avant <code><i>CMD</i></code> :</p>
<pre><code class="language-plaintext">--interval=DUREE (default: 30s)
--timeout=DUREE (default: 30s)
--start-period=DUREE (default: 0s)
--retries=N (default: 3)</code></pre>
<p><code>Ghost</code> √©tant une application web, l'utilisation de <code>curl</code> ou <code>wget</code> comme commande de v√©rification vient imm√©diatement √† l'esprit.</p>
<p>Ici on v√©rifie qu'une page web est pr√©sente et renvoie un code de retour <code>200</code> √† l'adresse <a href="http://localhost:2368/"><code>http://localhost:2368</code></a>.</p>
<p>On va pouvoir construire notre image :</p>
<pre><code class="language-plaintext">$ docker build -t ghost:healthcheck .</code></pre>
<p>Et lancer notre container :</p>
<pre><code class="language-plaintext">$ docker run -d --name some-ghost -p 2368:2368 ghost:healthcheck</code></pre>
<p>On peut v√©rifier l'√©tat de notre avec la commande <code>docker ps</code> :</p>
<pre><code class="language-plaintext">$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                           PORTS                    NAMES
a3435a4d95fd        ghost:healthcheck   "docker-entrypoint.s‚Ä¶"   3 seconds ago       Up 1 second (health: starting)   0.0.0.0:2368-&gt;2368/tcp   some-ghost</code></pre>
<p>L'instruction <code>HEALTHCHECK</code> peut renvoyer 3 codes de retour :</p>
<pre><code class="language-plaintext">0: success - the container is healthy and ready for use
1: unhealthy - the container is not working correctly
2: reserved - do not use this exit code</code></pre>
<p>Vous allez constaster visuellement de votre c√¥t√©, 3 √©tats possibles :</p>
<ul>
  <li><strong>Starting</strong>: Votre container est en cours de d√©marrage.</li>
  <li><strong>Healthy</strong>: La commande de check renvoie un <i>success.</i> Votre container est fonctionnel.</li>
  <li><strong>Unhealthy</strong>: Votre container ne fonctionne pas correctement !</li>
</ul>
<p>On peut constater lors de mon <code>docker ps</code> que notre container est toujours en cours de d√©marrage : nous avons eu un retour <code>starting</code>.</p>
<p>V√©rifions de nouveau quelques secondes plus tard :</p>
<pre><code class="language-plaintext">$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                        PORTS                    NAMES
a3435a4d95fd        ghost:healthcheck   "docker-entrypoint.s‚Ä¶"   About a minute ago   Up About a minute (healthy)   0.0.0.0:2368-&gt;2368/tcp   some-ghost</code></pre>
<p>Il est donc relativement simple d'ajouter ce m√©canisme √† votre image !</p>
<p>Toutefois le principal probl√®me li√© √† cette m√©thode, est que la v√©rification est alors g√©n√©rique. Il peut √™tre n√©cessaire de rendre vos checks plus "personnels", par container.</p>
<p>Il existe d'ailleurs un second inconv√©nient : votre image n'est peut-√™tre tout simplement pas pr√©vu "<i>seulement"</i> pour Docker. Kubernetes int√®gre par exemple ses propres m√©canismes, et vous souhaiterez probablement les utiliser...</p>
<p>&nbsp;</p>
<h2>Dans un docker-compose</h2>
<p>Dans ce cas, vous pouvez r√©aliser la m√™me v√©rification dans le fichier <code>docker-compose</code>.</p>
<p>üö© Pour cet exemple, je vais tout de m√™me construire une image. Sans <code>HEALTHCHECK</code>, mais avec l'installation de <code>curl</code> üö© :</p>
<pre><code class="language-plaintext">FROM ghost:3

RUN apt update &amp;&amp; apt install curl -y \
        &amp;&amp; rm -rf /var/lib/apt/lists/*</code></pre>
<p>et donc construire cette image :</p>
<pre><code class="language-plaintext">$ docker build -t ghost:curl .</code></pre>
<p>Les instructions sont similaires √† la m√©thode vu pr√©c√©demment :</p>
<pre><code class="language-plaintext">version: '3.8'
services:
    ghost:
        image: ghost:curl
        ports:
            - 2368:2368
        healthcheck:
            test: ["CMD", "curl -f http://localhost:2368 || exit 1"]
            timeout: 30s
            interval: 1m
            retries: 3</code></pre>
<p>Le fonctionnement est identique √† celui que nous venons de voir lors d'une utilisation de l'instruction au sein d'un fichier <code>Dockerfile</code>. ( ouf üòÇ )</p>
<p>Enfin sachez qu'il est tout simplement possible de d√©sactiver dans votre <code>docker-compose</code> un healthcheck cr√©√© dans une image √† l'aide de l'instruction suivante :</p>
<pre><code class="language-plaintext">healthcheck:
  disable: true</code></pre>
<p>&nbsp;</p>
<p style="text-align:right;">Source : <a href="https://www.grottedubarbu.fr/docker-healthcheck/">grottedubarbu.fr</a><br>&nbsp;</p>
